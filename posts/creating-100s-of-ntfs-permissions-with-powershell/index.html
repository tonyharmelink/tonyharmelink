<!doctype html>
<html>
  <head>
    <title>Creating 100s of NTFS permissions with Powershell // @TonyHarmelink blogging!</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.54.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Tony Harmelink" />
    <meta name="description" content="" />
    <base href="https://tonyh.dev/" />
    <link rel="stylesheet" href="https://tonyh.dev/css/main.min.ed2bee65dbc2f611ff1a2ca5cfa6d7ec362a8e79fea5cf61bb5213445359e232.css" />
  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="./avatar.jpg" /></a>
      <h1>@TonyHarmelink blogging!</h1>
      <p>I&#39;m Tony Harmelink. I work primarily on SysAdmin, DevOps, and EUC projects</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/tonyharmelink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/tonyharmelink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Creating 100s of NTFS permissions with Powershell</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Mar 28, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://tonyh.dev/tags/powershell/">Powershell</a></div></div>
    </header>
    <div class="post-content">
      <p>Starting at my new employer one of the first major projects to hit implementation phase is a migration of the company file server.  The major wrinkle is that the old file server is on Novell, with 25+ years of permission and folder buildup. Millions of files, hundreds of thousands of folders.</p>

<p>The normal Windows to Windows robocopy won&rsquo;t work to preserve permissions, all permissions must be mapped from Novell OUs, Groups, &amp; Users to AD OUs, Groups, &amp; Users and subsequently applied to the newly copied files and folders on a Windows file server.</p>

<p>If the permissions were simple this would be no issue, but with so many years of inertia it is a bit of a mess with around 600 different points where permissions are applied, inheritance broken, or traversal needing to be mapped to match 1 to 1. No way I am doing that by hand.</p>

<p>Luckily I have Powershell Desired State Configuration and foreach at my disposal. It comes down to two components. A CSV file that my boss can use to map the existing Novell permissions to their new AD permissions and a powershell script heavily utilizing <a href="https://github.com/SNikalaichyk/cNtfsAccessControl" title="cNtfsAccessControl">cNtfsAccessControl</a>. Because of the number of lines in the output *.mof and the need for unique naming I utilize guid generation for naming.</p>

<p>Here&rsquo;s a small snip of the start of my script. Available <a href="https://github.com/tonyharmelink/powershell-scripts/tree/master/MigrateFileServer" title="https://github.com/tonyharmelink/powershell-scripts/tree/master/MigrateFileServer">here</a>.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ps1" data-lang="ps1">\<span style="color:#75715e"># Parse the lines from our CSV, expected columns are:</span>
\<span style="color:#75715e"># Folder path, full path with drive D:\[bla\]</span>
\<span style="color:#75715e"># newFull to designate a principal to recieve a Full Access permission</span>
\<span style="color:#75715e"># newRW to designate a principal to recieve a Read and Write permission</span>
\<span style="color:#75715e"># newRO to designate a principal to recieve a Read Only permission</span>
\<span style="color:#75715e"># folderTraverse to designate a principal to recieve a Folder Traversal permission</span>
\<span style="color:#75715e"># noAccess to break inheretance, make permissions, and remove the noAccess principal</span>

            Import-Csv <span style="color:#e6db74">&#34;.\home.csv&#34;</span> | <span style="color:#66d9ef">ForEach</span>-Object {
    
                <span style="color:#75715e"># If there is a principal to apply a Full Access permission to</span>
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> (<span style="color:#66d9ef">[string]</span>::IsNullOrEmpty($_.newFull)))
                {
    
                    cNtfsPermissionEntry <span style="color:#e6db74">&#34;@{ Result = </span>$(<span style="color:#66d9ef">[guid]</span>::NewGuid())<span style="color:#e6db74">.$_.Folder.$_.newFull }&#34;</span>
                    {
                        Ensure = <span style="color:#e6db74">&#39;Present&#39;</span>
                        Path = $_.Folder
                        Principal = $_.newFull
                        AccessControlInformation = @(
                            cNtfsAccessControlInformation
                            {
                                AccessControlType = <span style="color:#e6db74">&#39;Allow&#39;</span>
                                FileSystemRights = <span style="color:#e6db74">&#39;FullControl&#39;</span>
                                Inheritance = <span style="color:#e6db74">&#39;ThisFolderSubfoldersAndFiles&#39;</span>
                                NoPropagateInherit = $false
                            }
                        )
                    }
                }</code></pre></div>

<p>The execution went well. All of the files were pre-copied with robocopy onto the new server. The days leading up to and the night of the cutover we used Beyond Compare to sync any delta changes. With DSC we can re-run the same script and it only makes changes to new files/folders or any permission alterations we have made to the CSV.</p>

<p>Huge success!</p>

    </div>
  </article>

    </main>
  </body>
</html>
